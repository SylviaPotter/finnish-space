<script>
    let words = [];
    let currentPage = 0;
    const itemsPerPage = 5;

    // Event listener for local file upload
    document.getElementById('fileUpload').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                words = rows.map(row => {
                    const [finnish, english] = row;
                    if (finnish && english) {
                        return { finnish: finnish.trim(), english: english.trim() };
                    }
                }).filter(pair => pair); // 过滤掉任何无效条目
            };
            reader.readAsArrayBuffer(file);
        }
    });

    // Function to fetch file list from GitHub repository
    async function fetchGitHubFiles() {
        const repoUrl = 'https://api.github.com/repos/SylviaPotter/finnish-space/contents/';
        try {
            const response = await fetch(repoUrl);
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            const files = await response.json();
            const fileSelect = document.getElementById('fileSelect');
            fileSelect.innerHTML = '<option value="">Select a file from GitHub...</option>';
            files.forEach(file => {
                if (file.name.endsWith('.xlsx')) {
                    const option = document.createElement('option');
                    option.value = file.download_url; // Set the download URL as the value
                    option.textContent = file.name;
                    fileSelect.appendChild(option);
                }
            });
        } catch (error) {
            console.error("Error fetching files from GitHub:", error);
            alert("There was an error fetching files from the GitHub repository.");
        }
    }

    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    async function startGame() {
        const fileUrl = document.getElementById('fileSelect').value;

        if (fileUrl) {
            try {
                const response = await fetch(fileUrl);
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }

                const arrayBuffer = await response.arrayBuffer();
                readExcelBuffer(arrayBuffer);
            } catch (error) {
                console.error("Error fetching or processing the file:", error);
                alert("There was an error fetching or processing the file.");
            }
        } else if (words.length === 0) {
            alert("Please upload a valid word list first.");
        } else {
            words = shuffle(words);
            currentPage = 0;
            renderPage();
            updatePaginationButtons();
        }
    }

    function readExcelBuffer(buffer) {
        const workbook = XLSX.read(buffer, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        words = rows.map(row => {
            const [finnish, english] = row;
            if (finnish && english) {
                return { finnish: finnish.trim(), english: english.trim() };
            }
        }).filter(pair => pair); // 过滤掉任何无效条目

        currentPage = 0;
        renderPage();
        updatePaginationButtons();
    }

    function renderPage() {
        const finnishColumn = document.getElementById('finnish-column');
        const englishColumn = document.getElementById('english-column');
        finnishColumn.innerHTML = '';
        englishColumn.innerHTML = '';

        const start = currentPage * itemsPerPage;
        const end = Math.min(start + itemsPerPage, words.length);
        let pageWords = words.slice(start, end);

        // For each word pair, create Finnish and English cards separately in different columns
        pageWords.forEach(pair => {
            // Create Finnish word card
            const finnishCard = document.createElement('div');
            finnishCard.classList.add('word-card');
            finnishCard.textContent = pair.finnish;
            finnishCard.dataset.matchId = pair.finnish;

            // Create English word card
            const englishCard = document.createElement('div');
            englishCard.classList.add('word-card');
            englishCard.textContent = pair.english;
            englishCard.dataset.matchId = pair.finnish;

            // Append cards to respective columns
            finnishColumn.appendChild(finnishCard);
            englishColumn.appendChild(englishCard);
        });

        // Shuffle the cards within each column for randomness
        shuffleColumnCards(finnishColumn);
        shuffleColumnCards(englishColumn);
        addClickEvents();
    }

    function shuffleColumnCards(column) {
        for (let i = column.children.length; i >= 0; i--) {
            column.appendChild(column.children[Math.random() * i | 0]);
        }
    }

    function addClickEvents() {
        let selectedCard = null;
        document.querySelectorAll('.word-card').forEach(card => {
            card.addEventListener('click', function() {
                if (card.classList.contains('matched') || card === selectedCard) {
                    return; // 忽略已匹配或已选中的卡片
                }

                card.classList.add('selected');

                if (!selectedCard) {
                    selectedCard = card;
                } else {
                    if (selectedCard.dataset.matchId === card.dataset.matchId) {
                        selectedCard.classList.add('matched');
                        card.classList.add('matched');
                    }
                    selectedCard.classList.remove('selected');
                    card.classList.remove('selected');
                    selectedCard = null;
                }
            });
        });
    }

    function updatePaginationButtons() {
        document.getElementById('prevButton').disabled = currentPage === 0;
        document.getElementById('nextButton').disabled = (currentPage + 1) * itemsPerPage >= words.length;
    }

    function nextPage() {
        if ((currentPage + 1) * itemsPerPage < words.length) {
            currentPage++;
            renderPage();
            updatePaginationButtons();
        }
    }

    function prevPage() {
        if (currentPage > 0) {
            currentPage--;
            renderPage();
            updatePaginationButtons();
        }
    }
</script>
